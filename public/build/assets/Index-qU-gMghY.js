import{r as i,b as g,j as e,L as Y,S as Z}from"./app-CMgd9CFO.js";import{A as ee,d as S,e as k}from"./app-layout-BIPqPh_6.js";import{B as b}from"./button-Daq97pcb.js";import{E as se,C as te}from"./card-BE3_cUCb.js";import{I as F}from"./input-HZKsKJ3U.js";import{S as M}from"./separator-BNbRGGQA.js";import{S as ae}from"./search-LkEQWFqZ.js";import{T as z}from"./trash-2-BeWJk30g.js";import{S as re,E as ne,C as oe}from"./send-CvqZSALe.js";import{c as ie}from"./createLucideIcon-7qGfDxei.js";import{P as le}from"./paw-print-D0UC6vtx.js";import{L as O}from"./loader-circle-Ck6Q4JL4.js";import{C as ce}from"./chevron-left-CX5OGnks.js";import{C as de}from"./chevron-right-NGM6CfF9.js";import{C as me}from"./check-D-GLxgsM.js";import"./index-BCYOheS7.js";import"./index-DZZQifJx.js";import"./utils-jAU0Cazi.js";import"./index-BuHSMQr-.js";import"./index-CVIgW6Jv.js";import"./index-Dws4ymEe.js";import"./index-tFwqN7HY.js";import"./x-BWEyVoTj.js";import"./index-gfCreU1N.js";import"./user-BaUwBdqr.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]],D=ie("CheckCheck",ue),pe=[{title:"WhatsApp Inbox",href:"/admin/whatsapp-inbox"}];function ze({conversations:W,auth:x}){const[B,j]=i.useState(W),[a,U]=i.useState(null),[L,d]=i.useState([]),[w,T]=i.useState(""),[q,I]=i.useState(!1),[N,Q]=i.useState(""),[P,v]=i.useState([]),[c,y]=i.useState({current_page:1,last_page:1,total:0}),[_,A]=i.useState(!1),E=i.useRef(null),m=i.useRef(null),C=i.useRef(0),f=i.useRef(0),V=()=>{var s;(s=E.current)==null||s.scrollIntoView({behavior:"smooth"})};i.useEffect(()=>{V()},[L]),i.useEffect(()=>{const s=setInterval(async()=>{var t;if(a)try{const u=(await g.get(route("whatsapp-inbox.show",a.phone_number))).data.messages,l=u.filter(n=>n.direction==="inbound");l.length>C.current&&C.current>0&&m.current&&(m.current.currentTime=0,m.current.play().catch(()=>{})),C.current=l.length,d(n=>{const o=n.filter(p=>p.isOptimistic);return[...u.filter(p=>!o.some(X=>X.id===p.id)),...o.filter(p=>p.status==="sending")]})}catch{}try{const r=await g.get(route("whatsapp-inbox.conversations"));if((t=r.data)!=null&&t.conversations){const u=r.data.conversations,l=u.reduce((n,o)=>n+(o.unread_count??0),0);l>f.current&&f.current>=0&&(console.log("New message detected! Playing sound...",{prev:f.current,new:l}),m.current&&(m.current.currentTime=0,m.current.play().catch(n=>{console.warn("Could not play notification sound:",n.message)}))),f.current=l,j(u)}}catch{}},5e3);return()=>clearInterval(s)},[a]);const G=async s=>{U(s),I(!0),j(t=>t.map(r=>r.phone_number===s.phone_number?{...r,unread:!1}:r));try{const t=await g.get(route("whatsapp-inbox.show",s.phone_number));d(t.data.messages),t.data.pets?(v(t.data.pets.data||[]),y({current_page:t.data.pets.current_page||1,last_page:t.data.pets.last_page||1,total:t.data.pets.total||0})):(v([]),y({current_page:1,last_page:1,total:0}))}catch(t){console.error("Failed to fetch messages",t)}finally{I(!1)}},R=async s=>{if(a){A(!0);try{const t=await g.get(route("whatsapp-inbox.show",a.phone_number),{params:{page:s}});t.data.pets&&(v(t.data.pets.data||[]),y({current_page:t.data.pets.current_page||1,last_page:t.data.pets.last_page||1,total:t.data.pets.total||0}))}catch(t){console.error("Failed to fetch pets",t)}finally{A(!1)}}},H=async s=>{if(s.preventDefault(),!w.trim()||!a)return;const t=w,r=`temp-${Date.now()}`,u={id:r,phone_number:a.phone_number,message:t,direction:"outbound",status:"sending",created_at:new Date().toISOString(),isOptimistic:!0};d(l=>[...l,u]),T("");try{const l=await g.post(route("whatsapp-inbox.send"),{phone_number:a.phone_number,message:t,customer_id:a.customer_id});if(l.data.status==="success")d(n=>n.map(o=>o.id===r?{...o,status:"sent",isOptimistic:!1,id:l.data.message_id||r}:o)),j(n=>n.map(h=>h.phone_number===a.phone_number?{...h,last_message:t,last_message_at:new Date().toISOString(),direction:"outbound"}:h).sort((h,p)=>new Date(p.last_message_at).getTime()-new Date(h.last_message_at).getTime()));else throw new Error("Send failed")}catch(l){console.error("Failed to send message",l),d(n=>n.map(o=>o.id===r?{...o,status:"failed"}:o)),setTimeout(()=>{d(n=>n.filter(o=>o.id!==r))},1e4)}},$=async s=>{if(confirm("Are you sure you want to delete this message?"))try{await g.delete(route("whatsapp-inbox.destroy"),{data:{message_id:s}}),d(t=>t.filter(r=>r.id!==s))}catch(t){console.error("Failed to delete message",t),alert("Failed to delete message")}},J=B.filter(s=>s.customer_name.toLowerCase().includes(N.toLowerCase())||s.phone_number.includes(N)).sort((s,t)=>new Date(t.last_message_at).getTime()-new Date(s.last_message_at).getTime()),K=s=>{if(s.direction!=="outbound")return null;switch(s.status){case"sending":return e.jsx(O,{className:"h-3 w-3 animate-spin"});case"failed":return e.jsx(oe,{className:"h-3 w-3 text-red-400"});case"sent":return e.jsx(me,{className:"h-3 w-3"});case"delivered":case"read":default:return e.jsx(D,{className:"h-3 w-3"})}};return e.jsxs(ee,{breadcrumbs:pe,children:[e.jsx(Y,{title:"WhatsApp Inbox"}),e.jsx("audio",{ref:m,src:"/music/message_sound.mp3",preload:"auto"}),e.jsxs("div",{className:"flex h-[calc(100vh-140px)] w-full overflow-hidden rounded-xl border bg-background shadow-sm",children:[e.jsxs("div",{className:"flex w-1/4 flex-col border-r bg-muted/30",children:[e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(ae,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(F,{placeholder:"Search or start new chat",className:"pl-9",value:N,onChange:s=>Q(s.target.value)})]})}),e.jsx(M,{}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:J.map(s=>e.jsxs("div",{onClick:()=>G(s),className:`flex cursor-pointer items-center gap-3 p-4 hover:bg-muted/50 ${(a==null?void 0:a.phone_number)===s.phone_number?"bg-primary/10":""}`,children:[e.jsxs("div",{className:"relative",children:[e.jsx(S,{children:e.jsx(k,{className:"bg-primary/20 text-primary",children:s.customer_name.substring(0,2).toUpperCase()})}),(s.unread_count??0)>0&&e.jsx("span",{className:"absolute -top-1 -right-1 h-5 w-5 rounded-full bg-green-500 border-2 border-background flex items-center justify-center text-[10px] font-bold text-white",children:s.unread_count})]}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:`font-semibold truncate ${(s.unread_count??0)>0?"text-foreground":""}`,children:s.customer_name}),e.jsx("span",{className:`text-[10px] ${(s.unread_count??0)>0?"text-green-600 font-medium":"text-muted-foreground"}`,children:new Date(s.last_message_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:`text-sm truncate ${(s.unread_count??0)>0?"text-foreground font-medium":"text-muted-foreground"}`,children:s.last_message})]})]},s.phone_number))})]}),e.jsx("div",{className:"flex flex-1 flex-col bg-panel",children:a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between border-b p-3 bg-background",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(S,{children:e.jsx(k,{className:"bg-primary/20 text-primary uppercase",children:a.customer_name.substring(0,2)})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold leading-tight",children:a.customer_name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a.phone_number})]})]}),e.jsx("div",{className:"flex gap-4 text-muted-foreground",children:e.jsx(se,{className:"h-5 w-5 cursor-pointer"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",style:{backgroundImage:"radial-gradient(var(--border) 1px, transparent 0)",backgroundSize:"24px 24px"},children:q?e.jsx("div",{className:"flex h-full items-center justify-center text-muted-foreground",children:"Loading..."}):e.jsxs(e.Fragment,{children:[L.map(s=>{var t,r;return e.jsxs("div",{className:`group flex items-center gap-2 ${s.direction==="outbound"?"justify-end":"justify-start"}`,children:[((t=x==null?void 0:x.user)==null?void 0:t.email)==="admin@admin.com"&&s.direction==="outbound"&&!s.isOptimistic&&e.jsx("button",{onClick:()=>$(s.id),className:"opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-red-100",title:"Delete message",children:e.jsx(z,{className:"h-4 w-4 text-red-500"})}),e.jsxs("div",{className:`max-w-[70%] rounded-lg px-4 py-2 shadow-sm transition-opacity ${s.direction==="outbound"?`bg-primary text-primary-foreground rounded-tr-none ${s.status==="sending"?"opacity-70":""} ${s.status==="failed"?"bg-red-500":""}`:"bg-card text-card-foreground rounded-tl-none border"}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.message}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-1 text-[10px]",children:[s.status!=="sending"&&e.jsx("span",{children:new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),K(s)]})]}),((r=x==null?void 0:x.user)==null?void 0:r.email)==="admin@admin.com"&&s.direction==="inbound"&&e.jsx("button",{onClick:()=>$(s.id),className:"opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-red-100",title:"Delete message",children:e.jsx(z,{className:"h-4 w-4 text-red-500"})})]},s.id)}),e.jsx("div",{ref:E})]})}),e.jsx("div",{className:"border-t p-3 bg-background",children:e.jsxs("form",{onSubmit:H,className:"flex items-center gap-3",children:[e.jsx(F,{placeholder:"Type a message",className:"flex-1 focus-visible:ring-primary",value:w,onChange:s=>T(s.target.value)}),e.jsx(b,{type:"submit",size:"icon",className:"h-10 w-10 rounded-full shrink-0",children:e.jsx(re,{className:"h-5 w-5"})})]})})]}):e.jsxs("div",{className:"flex h-full flex-col items-center justify-center text-center p-8 bg-muted/10",children:[e.jsx("div",{className:"mb-4 flex h-20 w-20 items-center justify-center rounded-full bg-primary/20 text-primary",children:e.jsx(D,{className:"h-10 w-10"})}),e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:"WhatsApp Web for Admin"}),e.jsx("p",{className:"text-muted-foreground max-w-md mt-2",children:"Select a contact to view the conversation or start messaging. All messages are synchronized with your WhatsApp Business account."}),e.jsx(M,{className:"my-8 w-1/3"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground uppercase tracking-widest",children:[e.jsx(D,{className:"h-4 w-4"}),"End-to-end encrypted"]})]})}),a&&e.jsxs("div",{className:"hidden w-1/4 border-l bg-muted/20 lg:flex flex-col",children:[e.jsxs("div",{className:"p-6 text-center",children:[e.jsx(S,{className:"h-24 w-24 mx-auto mb-4 border-4 border-background",children:e.jsx(k,{className:"bg-primary/20 text-primary text-2xl",children:a.customer_name.substring(0,2).toUpperCase()})}),e.jsx("h3",{className:"text-lg font-bold",children:a.customer_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a.phone_number})]}),e.jsx(M,{}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[e.jsxs("h4",{className:"text-xs font-semibold text-muted-foreground uppercase mb-3 flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4"}),"Pet Cremations (",c.total,")"]}),_?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(O,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):P.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No pets found"}):e.jsx("div",{className:"space-y-3",children:P.map(s=>e.jsx(te,{className:"p-3 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h5",{className:"font-semibold text-sm truncate",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.cremationDate?new Date(s.cremationDate).toLocaleDateString():"No date"}),e.jsx("span",{className:`inline-block mt-1 text-[10px] px-2 py-0.5 rounded-full font-medium ${s.status==="Completed"?"bg-green-100 text-green-700":s.status==="In Progress"?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:s.status||"Pending"})]}),e.jsx(b,{size:"sm",variant:"outline",className:"shrink-0 h-8 w-8 p-0",onClick:()=>Z.visit(route("cremation.edit",s.id)),children:e.jsx(ne,{className:"h-4 w-4"})})]})},s.id))}),c.last_page>1&&e.jsxs("div",{className:"flex items-center justify-center gap-2 mt-4 pt-4 border-t",children:[e.jsx(b,{size:"sm",variant:"outline",disabled:c.current_page<=1||_,onClick:()=>R(c.current_page-1),children:e.jsx(ce,{className:"h-4 w-4"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[c.current_page," / ",c.last_page]}),e.jsx(b,{size:"sm",variant:"outline",disabled:c.current_page>=c.last_page||_,onClick:()=>R(c.current_page+1),children:e.jsx(de,{className:"h-4 w-4"})})]})]})]})]})]})}export{ze as default};
